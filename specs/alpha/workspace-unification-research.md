# Workspace Unification Research

> Research output for Task #4 — Xcode workspace unification strategy
> Date: 2026-02-07

---

## 1. Current State Analysis

### Project Layout

```
ils-ios/                          # Git root
├── Package.swift                 # SPM package: ILSShared (lib) + ILSBackend (executable)
├── Sources/
│   ├── ILSShared/               # 15 Swift files — shared models & DTOs
│   │   ├── Models/              # Session, Project, Skill, Plugin, MCPServer, etc.
│   │   └── DTOs/                # ConnectionResponse, Requests, SystemDTOs, etc.
│   └── ILSBackend/              # 36 Swift files — Vapor server
│       ├── App/                 # entrypoint.swift, configure.swift, routes.swift
│       ├── Controllers/         # 10 route controllers
│       ├── Services/            # 12 services (Claude executor, SSE streaming, etc.)
│       ├── Models/              # Fluent ORM models
│       ├── Migrations/          # SQLite migrations
│       └── Middleware/          # Error middleware
├── ILSApp/                      # iOS app subdirectory
│   ├── ILSApp.xcodeproj/       # Xcode project (2 targets: ILSApp + ILSAppUITests)
│   └── ILSApp/                  # 78 Swift files — SwiftUI iOS app
│       ├── Services/            # APIClient, SSEClient, ConnectionManager, etc.
│       ├── ViewModels/          # 8 view models
│       ├── Views/               # Chat, Sessions, Settings, System, Browser, etc.
│       └── Theme/               # 12 themes, components, entity system
├── ILSFullStack.xcworkspace/    # Existing workspace (partially set up)
├── Tests/                       # SPM test targets
│   ├── ILSSharedTests/
│   └── ILSBackendTests/
└── ILSAppUITests/               # Xcode UI test target
```

### How ILSShared is Currently Shared

The iOS app's `ILSApp.xcodeproj` uses a **local SPM package reference** (`XCLocalSwiftPackageReference ".."`) pointing to the parent `Package.swift`. This gives the iOS app access to `ILSShared` as a dependency. The backend gets `ILSShared` natively through SPM since both are in the same `Package.swift`.

**This is already the correct pattern** recommended by Apple (WWDC22).

### Existing Workspace: ILSFullStack.xcworkspace

The workspace file at `ILSFullStack.xcworkspace/contents.xcworkspacedata` contains:

```xml
<Workspace version="1.0">
  <FileRef location="group:ILSApp/ILSApp.xcodeproj"/>
  <Group location="container:" name="Backend">
    <FileRef location="group:Sources"/>
    <FileRef location="group:Package.swift"/>
    <FileRef location="group:Package.resolved"/>
  </Group>
</Workspace>
```

**State:** Partially functional. It references the iOS project and the backend source files, but:
- No shared schemes for the workspace itself
- Backend "Group" is for file viewing only — not a buildable target in the workspace
- The `ILSBackend` scheme auto-generated by SPM is only accessible from within the `ILSApp.xcodeproj` context (because it pulls in the parent Package.swift)

### Existing Schemes (from ILSApp.xcodeproj)

| Scheme | Type | Notes |
|--------|------|-------|
| ILSApp | Shared | iOS app for simulator/device |
| ILSBackend | Auto-generated | SPM executable (from Package.swift local ref) |
| ILSShared | Auto-generated | SPM library |
| HighlightSwift | Auto-generated | Remote SPM dependency |
| MarkdownUI | Auto-generated | Remote SPM dependency |

### Current Build Methods

| Component | Current Build Method |
|-----------|---------------------|
| iOS App | `xcodebuild -project ILSApp/ILSApp.xcodeproj -scheme ILSApp` |
| Backend | `swift run ILSBackend` (CLI) or Xcode via auto-generated ILSBackend scheme |
| Both | Manual: start backend in terminal, then run iOS app in Xcode |

---

## 2. Tool Availability

| Tool | Installed | Version | Notes |
|------|-----------|---------|-------|
| XcodeGen | Yes | 2.44.1 | `/opt/homebrew/bin/xcodegen` |
| Tuist | Yes | 4.134.0 | `/opt/homebrew/bin/tuist` (via Homebrew) |
| Mint | No | - | Not needed; XcodeGen/Tuist installed directly |
| Xcode | Yes | 16.x | LastUpgradeVersion = 1600 in scheme |

---

## 3. Approaches Evaluated

### Approach A: Enhanced Manual Workspace (RECOMMENDED)

**What:** Improve the existing `ILSFullStack.xcworkspace` by adding proper shared schemes for all three build configurations (iOS only, Backend only, Full Stack).

**How it works:**
- The workspace already references `ILSApp.xcodeproj` and the backend source files
- The iOS project already has a local SPM reference to the parent `Package.swift`, which provides `ILSShared` and `ILSBackend` as buildable schemes
- We just need to create **workspace-level shared schemes** and configure them properly

**Pros:**
- Minimal change — builds on existing infrastructure
- No new tools or generated files
- No migration risk — the xcodeproj is already hand-crafted and working
- Xcode natively understands the SPM dependency graph
- ILSShared already shared correctly via local SPM reference
- Vapor's custom working directory can be set in the scheme

**Cons:**
- Workspace schemes must be manually maintained (but they rarely change)
- No "Full Stack" single-click launch (Xcode doesn't natively support "run two targets simultaneously")
- pbxproj changes still produce merge conflicts

**Effort:** Low (1-2 hours)

### Approach B: XcodeGen-Generated Project

**What:** Replace `ILSApp.xcodeproj` with a `project.yml` that XcodeGen generates.

**How it works:**
- Define all iOS targets, dependencies, build settings in `project.yml`
- Run `xcodegen generate` to produce `ILSApp.xcodeproj`
- Keep the workspace as the outer container

**Pros:**
- Eliminates pbxproj merge conflicts
- Declarative project definition
- Easy to add new targets/schemes

**Cons:**
- Migration effort: must replicate ALL current build settings, entitlements, Info.plist references, SPM dependencies
- XcodeGen doesn't generate workspace files — still need manual workspace
- Backend still built via SPM (XcodeGen doesn't handle SPM executable targets well for macOS/server)
- Risk of subtle configuration differences during migration
- Team must learn project.yml format

**Effort:** Medium (4-6 hours)

### Approach C: Tuist-Managed Project

**What:** Replace both the xcodeproj and workspace with Tuist manifests (Project.swift, Workspace.swift).

**How it works:**
- Define everything in Swift using Tuist's manifest DSL
- Run `tuist generate` to produce both .xcodeproj and .xcworkspace

**Pros:**
- Swift-native configuration (type-safe)
- Can define workspace-level schemes
- Handles complex dependency graphs
- Built-in caching and selective compilation

**Cons:**
- Highest migration effort
- Must learn Tuist's opinionated project structure
- Tuist 4.x has breaking changes from earlier versions
- Adds a build-time dependency (must run `tuist generate` before opening)
- Overkill for a 2-target project
- Tuist's SPM integration can conflict with manual Package.swift

**Effort:** High (8-12 hours)

### Approach D: Pure SPM (Package.swift for everything)

**What:** Move the iOS app target into Package.swift as well.

**How it works:**
- Add an iOS app target to Package.swift
- Use `swift build` for everything

**Pros:**
- Single Package.swift controls all dependencies
- No xcodeproj at all

**Cons:**
- SPM cannot produce `.app` bundles (no support for iOS resources, asset catalogs, storyboards, Info.plist, entitlements)
- SwiftUI previews won't work
- No simulator debugging
- Not viable for iOS apps

**Effort:** Not feasible

---

## 4. Recommended Approach: Enhanced Manual Workspace (A)

### Rationale

1. **Already 90% there.** The workspace exists, the local SPM reference works, the backend schemes are auto-generated.
2. **Minimal disruption.** No tool changes, no regeneration step, no new formats to learn.
3. **Apple's recommended pattern.** WWDC22 "Use Xcode for server-side development" session recommends exactly this: workspace with separate projects/packages for server and client, shared code via SPM library.
4. **XcodeGen/Tuist add complexity for marginal benefit.** With only 2 targets (iOS app + server), the pbxproj merge conflict problem is manageable.

### What Needs to Change

| Change | Description |
|--------|-------------|
| Add workspace shared schemes | Create 3 shared schemes at workspace level |
| ILSBackend scheme: custom working directory | Set to project root so Vapor finds `.env`, `Public/`, SQLite DB |
| ILSFullStack scheme: pre-action script | Launch backend before iOS app (or document manual workflow) |
| Workspace references cleanup | Ensure backend sources visible in workspace navigator |

---

## 5. Step-by-Step Plan

### Step 1: Create Workspace Shared Schemes Directory

```bash
mkdir -p ILSFullStack.xcworkspace/xcshareddata/xcschemes
```

### Step 2: Create "ILSApp" Workspace Scheme

This scheme builds and runs the iOS app on the simulator. It references the `ILSApp` target from `ILSApp.xcodeproj`.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Scheme LastUpgradeVersion="1600" version="1.7">
  <BuildAction parallelizeBuildables="YES" buildImplicitDependencies="YES">
    <BuildActionEntries>
      <BuildActionEntry buildForRunning="YES" buildForTesting="YES" buildForProfiling="YES" buildForArchiving="YES" buildForAnalyzing="YES">
        <BuildableReference
          BuildableIdentifier="primary"
          BlueprintIdentifier="00000000000000000000000E"
          BuildableName="ILSApp.app"
          BlueprintName="ILSApp"
          ReferencedContainer="container:ILSApp/ILSApp.xcodeproj"/>
      </BuildActionEntry>
    </BuildActionEntries>
  </BuildAction>
  <LaunchAction buildConfiguration="Debug" selectedDebuggerIdentifier="Xcode.DebuggerFoundation.Debugger.LLDB" selectedLauncherIdentifier="Xcode.DebuggerFoundation.Launcher.LLDB" launchStyle="0" useCustomWorkingDirectory="NO" allowLocationSimulation="YES">
    <BuildableProductRunnable runnableDebuggingMode="0">
      <BuildableReference
        BuildableIdentifier="primary"
        BlueprintIdentifier="00000000000000000000000E"
        BuildableName="ILSApp.app"
        BlueprintName="ILSApp"
        ReferencedContainer="container:ILSApp/ILSApp.xcodeproj"/>
    </BuildableProductRunnable>
  </LaunchAction>
</Scheme>
```

### Step 3: Create "ILSBackend" Workspace Scheme

This scheme builds and runs the Vapor backend on macOS. It uses a **custom working directory** pointed at the project root so Vapor can find its resources.

The key configuration is:
- Destination: **My Mac** (macOS, not iOS simulator)
- Custom working directory: `$(SRCROOT)/..` or absolute path to `ils-ios/`
- Environment variable: `PORT=9090`

**Note:** The auto-generated `ILSBackend` scheme from SPM already works for building. We may just need to copy it to workspace-level shared schemes and add the custom working directory + environment variables.

### Step 4: Create "ILSFullStack" Scheme (Optional)

Xcode does not natively support launching two executables simultaneously from one scheme. Options:

**Option A: Pre-action build script (Recommended)**
Add a pre-action script to the iOS app scheme that starts the backend:

```bash
# Pre-action script in ILSApp scheme
cd "$WORKSPACE_PATH/.."
PORT=9090 swift run ILSBackend &
echo $! > /tmp/ils-backend.pid
```

And a post-action to stop it:
```bash
kill $(cat /tmp/ils-backend.pid) 2>/dev/null
rm -f /tmp/ils-backend.pid
```

**Option B: Two-step workflow (Simpler)**
Document that developers should:
1. Select `ILSBackend` scheme, destination: My Mac, press Run
2. Select `ILSApp` scheme, destination: iPhone simulator, press Run

Both can run simultaneously in Xcode (separate debug sessions).

**Option C: Makefile/script (CI-friendly)**
```bash
#!/bin/bash
# scripts/run-fullstack.sh
PORT=9090 swift run ILSBackend &
BACKEND_PID=$!
sleep 3
xcodebuild -workspace ILSFullStack.xcworkspace -scheme ILSApp -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build
kill $BACKEND_PID
```

### Step 5: Verify Build from Workspace

```bash
# Build iOS app via workspace
xcodebuild -workspace ILSFullStack.xcworkspace \
  -scheme ILSApp \
  -destination 'platform=iOS Simulator,name=iPhone 16 Pro Max' \
  -configuration Debug \
  build

# Build backend via workspace (macOS destination)
xcodebuild -workspace ILSFullStack.xcworkspace \
  -scheme ILSBackend \
  -destination 'platform=macOS' \
  -configuration Debug \
  build
```

### Step 6: Update Workspace Contents (Optional Enhancement)

Optionally improve the workspace file to better organize navigation:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Workspace version="1.0">
  <FileRef location="group:ILSApp/ILSApp.xcodeproj"/>
  <Group location="container:" name="Backend">
    <FileRef location="group:Sources/ILSBackend"/>
    <FileRef location="group:Package.swift"/>
  </Group>
  <Group location="container:" name="Shared">
    <FileRef location="group:Sources/ILSShared"/>
  </Group>
  <Group location="container:" name="Tests">
    <FileRef location="group:Tests"/>
  </Group>
</Workspace>
```

---

## 6. Scheme Strategy Summary

| Scheme | What it builds | Destination | Use Case |
|--------|---------------|-------------|----------|
| **ILSApp** | iOS app + ILSShared | iPhone Simulator | Frontend development |
| **ILSBackend** | Backend server + ILSShared | My Mac | Backend development, API testing |
| **ILSFullStack** | Both (pre-action starts backend, then builds iOS) | iPhone Simulator | Full integration testing |

---

## 7. How ILSShared Works (Current = Correct)

```
Package.swift
├── ILSShared (library target)      ← used by ILSBackend via SPM
│   ├── Models/ (Session, Project, Skill, Plugin, MCPServer, etc.)
│   └── DTOs/ (Requests, Responses, SystemDTOs, TunnelDTOs, etc.)
└── ILSBackend (executable target)  ← depends on ILSShared

ILSApp.xcodeproj
└── XCLocalSwiftPackageReference ".."  ← points to Package.swift
    └── ILSShared (product dependency)  ← used by ILSApp target
```

Both the iOS app and the backend get the **exact same** `ILSShared` source. Changes to `Sources/ILSShared/` are immediately reflected in both. This is the ideal setup — no code duplication, single source of truth.

---

## 8. XcodeGen Example (If Approach B is Chosen Later)

For reference, here's what a `project.yml` would look like:

```yaml
name: ILSApp
options:
  bundleIdPrefix: com.ils
  deploymentTarget:
    iOS: "17.0"
  xcodeVersion: "1600"

packages:
  ILSApp:
    path: ".."
  MarkdownUI:
    url: https://github.com/gonzalezreal/swift-markdown-ui
    from: "2.0.0"
  HighlightSwift:
    url: https://github.com/appstefan/HighlightSwift
    from: "1.0.0"

targets:
  ILSApp:
    type: application
    platform: iOS
    sources:
      - path: ILSApp
    dependencies:
      - package: ILSApp
        product: ILSShared
      - package: MarkdownUI
      - package: HighlightSwift
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.ils.app
        INFOPLIST_FILE: ILSApp/Info.plist
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon

  ILSAppUITests:
    type: bundle.ui-testing
    platform: iOS
    sources:
      - path: ../ILSAppUITests
    dependencies:
      - target: ILSApp

schemes:
  ILSApp:
    build:
      targets:
        ILSApp: all
    run:
      config: Debug
    test:
      config: Debug
      targets:
        - ILSAppUITests
```

---

## 9. Tuist Example (If Approach C is Chosen Later)

```swift
// Project.swift
import ProjectDescription

let project = Project(
    name: "ILSApp",
    packages: [
        .local(path: ".."),
        .remote(url: "https://github.com/gonzalezreal/swift-markdown-ui", requirement: .upToNextMajor(from: "2.0.0")),
        .remote(url: "https://github.com/appstefan/HighlightSwift", requirement: .upToNextMajor(from: "1.0.0")),
    ],
    targets: [
        .target(
            name: "ILSApp",
            destinations: .iOS,
            product: .app,
            bundleId: "com.ils.app",
            deploymentTargets: .iOS("17.0"),
            sources: ["ILSApp/**"],
            dependencies: [
                .package(product: "ILSShared"),
                .package(product: "MarkdownUI"),
                .package(product: "HighlightSwift"),
            ]
        ),
    ]
)
```

---

## 10. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Workspace scheme BlueprintIdentifiers may not match | Build fails | Verify IDs from project.pbxproj before creating schemes |
| Backend auto-generated scheme may conflict with workspace scheme | Duplicate schemes in Xcode UI | Name workspace scheme differently (e.g., "Backend Server") or remove auto-generated |
| Vapor custom working directory not set | Backend can't find DB, .env | Always set in scheme LaunchAction |
| SPM resolution takes long on first open | Slow first build | Package.resolved already cached |
| Full Stack pre-action script reliability | Backend may not start in time | Add `sleep 3` or health check loop |

---

## 11. Conclusion

**Recommended: Approach A (Enhanced Manual Workspace)**

The current project is already structured correctly following Apple's WWDC22 pattern:
- Shared code in an SPM library (`ILSShared`)
- Backend as an SPM executable (`ILSBackend`)
- iOS app in its own xcodeproj with local SPM dependency
- Workspace tying them together

The only missing pieces are:
1. **Workspace-level shared schemes** (3 schemes: iOS, Backend, Full Stack)
2. **Custom working directory** in the backend scheme
3. **Environment variable** (`PORT=9090`) in the backend scheme
4. **Better workspace file organization** (separate groups for Backend, Shared, Tests)

These are all straightforward additions requiring no new tools, no migration, and no risk of breaking the existing build.
