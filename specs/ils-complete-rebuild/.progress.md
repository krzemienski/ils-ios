---
spec: ils-complete-rebuild
basePath: specs/ils-complete-rebuild
phase: tasks
task: 0/42
updated: 2026-02-06T00:00:00-05:00
---

# Progress: ils-complete-rebuild

## Original Goal

Comprehensive gap analysis of the current ILS iOS app against the full specification documents (docs/ils.md and docs/ils-spec.md), followed by a complete rebuild plan achieving: (1) full feature parity with Claude Code CLI, (2) meticulous adherence to the design system and wireframes from the spec, and (3) all functionality working end-to-end with real data — no mocks, no stubs. The two reference docs define the complete architecture, API contracts, design tokens, wireframes, and phased build orchestration. The goal is to identify every gap between current implementation and spec, then produce a rebuild/improvement plan that brings the app to full spec compliance.

## Completed Tasks

- Research phase: Comprehensive gap analysis of all models, controllers, services, views, design system, and API contract
- Requirements phase: 18 user stories, 42 functional requirements, 15 NFRs covering all gaps from research
- [x] 1.1 Add Citadel dependency and shared models - PENDING_COMMIT
- [x] 1.4 Create backend SSHService - DONE

## Current Task

Awaiting next task

### Design Interview (from design.md)
- Architecture style: Extend existing (keep MVVM + Vapor)
- Technology constraints: No constraints
- Integration approach: Use existing APIs/interfaces

## Learnings

- **Task 1.4**: Citadel API differs from task spec — no `executeCommandStream` returning events with `.stdout`/`.stderr` cases as described. Actual API: `executeCommandStream(_ command:)` returns `AsyncThrowingStream<ExecCommandOutput, Error>` where `ExecCommandOutput` is enum `.stdout(ByteBuffer)` / `.stderr(ByteBuffer)`. Also `executeCommand` returns `ByteBuffer` not a stream. The `Insecure.RSA.PrivateKey` init is `sshRsa:` not `pem:`. `AuthMethod` is nested as `ServerConnection.AuthMethod`.
- **Task 1.4**: SSHClient is `final class` not Sendable — actor isolation works because SSHService is an actor and client access is serialized through actor methods.
- App has SIGNIFICANTLY diverged from both specs — evolved into a Claude Code session management client with chat/SSE streaming (none of which are in the original specs)
- SSH/Citadel remote management (the spec's core premise) is completely absent — app operates local-only via FileSystemService reading ~/.claude/
- Citadel dependency is NOT in Package.swift despite spec requiring it
- 7 spec endpoints are completely missing (auth/connect, server/status, skills/search, skills/install, mcp/:name PUT, plugins/search, marketplaces POST)
- Current has 3 EXTRA controllers not in spec (SessionsController, ChatController, ProjectsController) — these are high-value beyond-spec features
- Color tokens use Apple system colors (e.g. #1C1C1E, #34C759) not spec custom colors (#0D0D0D, #4CAF50) — 9 of 15 tokens mismatch
- Accent color: spec=#FF6B35, current=#FF6600 — close but different
- No SkillDetailView exists despite spec wireframe 4 defining it
- No GitHubService exists — all skill/plugin discovery is local-only
- ILSShared does NOT depend on Yams (only ILSBackend does) — spec had Yams in ILSShared for SKILL.md parsing
- ClaudeCodeSDK added as dependency (forked) — not in original spec
- Backend uses SQLite FILE (ils.sqlite) not in-memory — better for persistence
- Recommendation: incremental enhancement, NOT rebuild — 12 validated screens + SSE streaming too valuable to discard
- The biggest architectural decision is SSH vs local-first — this gates ~50% of remaining work
- Stitch MCP can generate the 4 missing/partial screen designs from spec wireframes
- Requirements phase: 18 user stories covering 8 feature areas with 70+ testable acceptance criteria
- SSH is confirmed needed but not as a gate — local-first with optional SSH is the right pattern per user interview
- Tab bar (spec wireframe 2) should be primary nav; existing sidebar becomes supplementary — resolves navigation question
- Chat/Sessions features need a home in the tab bar (5th tab or sidebar-only) — unresolved design question
- Citadel + SwiftNIO conflict risk is real — ClaudeCodeSDK already hit NIO/RunLoop issues; Citadel uses same NIO stack
- GitHub API rate limiting (60 req/hr unauth) makes IndexingService cache more important than initially scoped
- 6 unresolved questions documented for user decision before design phase proceeds
- Managed scope (enterprise config) deferred to v2 — too niche for App Store v1
- `ils.md` is authoritative for exact code/models; `ils-spec.md` is authoritative for design/wireframes — no contradictions found between them
- **Design phase**: Citadel MUST share Vapor's EventLoopGroup (app.eventLoopGroup) to avoid NIO conflict that broke ClaudeCodeSDK — separate EventLoopGroups cause RunLoop/NIO deadlock
- **Design phase**: SkillItem struct in CommandPaletteView.swift is redundant with Skill from ILSShared — should unify to avoid dual maintenance
- **Design phase**: FileSystemService already masks env vars in MCP responses (first 4 + last 4 chars) — preserve this pattern, don't re-implement
- **Design phase**: AppState uses ObservableObject + @Published, not @Observable — new VMs should match this pattern for consistency
- **Design phase**: APIClient is an actor with generic get/post/put/delete methods — all new endpoints should use this existing pattern, not create new HTTP abstractions
- **Design phase**: Backend uses APIResponse<T> wrapper consistently — new endpoints must wrap responses the same way
- **Design phase**: 5 phases identified: (1) SSH Foundation, (2) Design Tokens, (3) GitHub Integration, (4) Enhanced Views, (5) Model Alignment. Phases 1 and 2 can run in parallel.
- **Design phase**: ServerConnectionView should be optional gate, not mandatory — supports local-first usage where backend runs on same machine
- **Design phase**: Config write currently only supports "user" scope — needs extension for project/local scope in Phase 4
- **Design phase**: Git clone --depth 1 chosen for skill install over raw content fetch because SKILL.md may reference sibling files

## Interview Responses

### Requirements Interview (from requirements.md)
- Primary users: End users via App Store — needs polish, onboarding, App Store compliance
- Priority tradeoffs: Feature completeness — all spec features working
- Success criteria: Full spec compliance — every feature, endpoint, screen from both spec docs implemented and working
- Architecture decision: Mobile app connects to backend REST server. SSH IS needed for certain operations (managing remote Claude Code installations on servers). Backend already runs as REST API handling most operations. Future vision includes dynamic Cloudflare URLs for remote access. Not everything needs SSH — REST handles most things — but SSH needed for direct server access operations.
- Additional context: User wants Stitch MCP for design work

### Tasks Interview (from tasks.md)
- Testing depth: Comprehensive — functional validation plus E2E automation with simulator screenshots for every feature
- Deployment approach: App Store ready — full submission prep: Privacy Manifest, screenshots, App Store metadata
- Execution priority: Balanced — reasonable quality with speed, follow existing patterns but don't over-engineer

## Blockers

None — all design decisions resolved.

## Next

Task 1.2: Enhance existing shared models (Skill, Plugin)

- **Task 1.1**: Citadel 0.7.0 resolves and compiles fine with existing Vapor/NIO stack. ILSBackend exclude list is missing `Controllers/CLAUDE.md` (SPM warning) — should be added in a future task.
- **Task 1.1**: ILSShared now depends on Yams — this means the iOS app (which imports ILSShared) will also link Yams. This is fine since Yams is pure Swift with no platform restrictions.

## Task Planning Learnings

- **Task planning phase**: `SkillItem` is a DUPLICATE struct in `CommandPaletteView.swift` (line 128) that mirrors `Skill` from ILSShared but uses `String?` for `source` instead of `SkillSource` enum — must handle this type mismatch during unification (task 1.20)
- **Task planning phase**: `SkillsViewModel` already uses `SkillItem` (not `Skill`) throughout — the SkillItem->Skill migration touches 3 files minimum (CommandPaletteView, SkillsViewModel, SkillsListView)
- **Task planning phase**: iOS `APIClient.swift` has its OWN `APIResponse<T>` and `ListResponse<T>` types (lines 106-120) that shadow the ILSShared versions — these are Decodable-only versions suitable for the iOS client. New endpoints must match this pattern.
- **Task planning phase**: `MCPController` already has GET by name (`:name`) and DELETE but is missing PUT (update) — adding PUT is straightforward, follows existing pattern
- **Task planning phase**: `PluginsController.install()` is a placeholder returning mock data — needs real implementation to clone from marketplace
- **Task planning phase**: `StatsController` already has `GET /stats/recent` returning `RecentSessionsResponse` — Dashboard activity feed can use this existing endpoint, no new endpoint needed
- **Task planning phase**: Corner radius rename (M->Small, L->Medium, XL->Large) will cause cascading changes across ALL views that use `cornerRadiusM/L/XL` — high-risk for compile errors, must be done carefully in task 1.9
- **Task planning phase**: `configure.swift` registers 3 migrations (CreateProjects, CreateSessions, CreateMessages) — new `CreateCachedResults` migration goes here in task 4.1
- **Task planning phase**: FileSystemService has `claudeDirectory` and `userSettingsPath` public properties — new backend services should use these instead of hardcoding `~/.claude/` paths
- **Task planning phase**: 42 total tasks: 22 POC (Phase 1), 4 Refactoring (Phase 2), 4 Validation (Phase 3), 6 Quality Gates (Phase 4), 4 PR Lifecycle (Phase 5), plus [VERIFY] checkpoints throughout
