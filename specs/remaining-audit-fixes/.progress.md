---
spec: remaining-audit-fixes
basePath: specs/remaining-audit-fixes
phase: research
task: 0/0
updated: 2026-02-07T02:30:00Z
---

# Progress: remaining-audit-fixes

## Original Goal

Fix all remaining MEDIUM + LOW severity issues from the comprehensive 6-audit sweep (concurrency, memory, swiftui-architecture, swiftui-performance, networking, accessibility). CRITICAL and HIGH issues have already been fixed in commits bc1d2c6 and 233bf20.

## Completed Tasks

- [x] 1.1 Fix APIClient: scoped cache invalidation, skip final retry sleep, nonisolated coders
- [x] 1.2 Fix SSEClient: exponential backoff, nonisolated coders, print to AppLogger
- [x] 1.3 Fix ILSAppApp: weak capture, didSet to method, remove objectWillChange, nonisolated coders
- [x] 1.4 [VERIFY] Quality checkpoint: build succeeds after core service fixes
- [x] 1.5 Fix ChatViewModel: Timer to Task, cancellables cleanup, nonisolated decoder, print to AppLogger
- [x] 1.6 Fix SystemMetricsViewModel: dedicated URLSession, nonisolated decoder
- [x] 1.7 Fix TunnelSettingsView: DispatchQueue to Task, accessibility labels
- [x] 1.8 [VERIFY] Quality checkpoint: build succeeds after ViewModel fixes
- [x] 1.9 Fix SessionsListView: static formatters namespace, computed to method, font theme, color indicators
- [x] 1.10 Fix SkillsViewModel: didSet to method

- [x] 1.11 Fix ChatView: DispatchQueue to Task, computed to method
- [x] 1.12 Fix MetricsWebSocketClient: WebSocket fallback reset timer

## Current Task

Awaiting next task (1.9 complete)

## Learnings

- **Audit Scope**: 55 Swift files across 6 domains (concurrency, memory, architecture, performance, networking, accessibility)
- **Total Issues**: 43 (18 MEDIUM + 25 LOW) affecting 28 files
- **Effort**: 4-6 hours estimated
- **Pattern**: Most MEDIUM issues are defensive improvements, not critical bugs
- **SwiftUI Anti-pattern**: Published+didSet causes duplicate UI updates in AppState
- **Accessibility Gap**: 10 files use hardcoded font sizes bypassing theme system
- **Swift 6 Prep**: 4 concurrency issues preventative for strict mode
- **False Positives**: ~5 issues flagged but code already correct (SwiftUI defaults)
- **Research Method**: Grep pattern searches highly effective (8 patterns covered all domains)
- **Already Fixed**: QR code caching (bc1d2c6), search cache optimization (233bf20)
- **Requirements Phase**: 6 user stories map to 19 FRs, prioritized P1/P2/P3 by impact
- **Completeness Priority**: User interview confirmed fix ALL issues (no skips)
- **User Dual Focus**: Both developer experience (concurrency) and end-user (a11y) equally important
- **3-Phase Structure**: Phase 1 (MEDIUM P1), Phase 2 (LOW P2), Phase 3 (validation with evidence)
- **Success Gate**: Clean build + zero regressions + VoiceOver pass + Memory Instruments pass
- **Design Architecture**: In-place fixes with no restructuring — 21 issues across 18 files
- **File Grouping Strategy**: High-impact files (ILSAppApp, ChatViewModel, APIClient) get 3-4 fixes in single edit pass
- **Task-Based Timers**: Replace all Timer/DispatchQueue.asyncAfter with Task for Swift 6 alignment
- **URLSession Isolation**: Dedicated instances per ViewModel prevents @MainActor warnings
- **Cache Scoping**: Narrow invalidation to specific resources (not entire domains) improves hit rate
- **Exponential Backoff**: SSEClient needs true exponential (not linear) for reconnection
- **Formatter Pattern**: Move static formatters to namespace (SessionFormatters) not View properties
- **AppLogger Migration**: 30+ print() calls across 4 files need structured logging
- **Accessibility Compliance**: Status indicators need icon+text (not color-only) for WCAG 2.1
- **WebSocket Recovery**: 10min reset timer allows retry after transient failures
- **WS Reset Pattern**: Optional Date? + TimeInterval constant, check in connect() before fallback branch, set Date() when entering fallback
- **ChatView DispatchQueue**: Was in ChatInputView (same file), used for send button spring animation reset. Replaced with resetTask Task pattern. shouldShowTypingIndicator extracted from computed property to method.
- **SessionFormatters pattern**: Top-level enum with nonisolated(unsafe) static let for formatters. Circle status indicator replaced with HStack(Image+Text) using .caption2/.imageScale(.small) for icon + ILSTheme.captionFont for text. No hardcoded .font(.system(size:)) existed in this file — all already used ILSTheme fonts.

## Blockers

- None currently

## Learnings (Task Planning)

- **Actual font count lower**: Only 6 hardcoded `.font(.system(size:))` remain (not 10 as audited) — ios-app-polish2 already fixed most
- **DashboardViewModel no URLSession.shared**: Design listed M-CONC-1 for DashboardViewModel but code uses APIClient, not URLSession directly. Removed from tasks
- **didSet still present**: ILSAppApp.swift (lines 44, 61) and SkillsViewModel.swift (line 13) confirmed via grep
- **DispatchQueue.asyncAfter broader than scoped**: Found in 9 locations across 8 files, but audit only scoped 2 (TunnelSettingsView, ChatView). Others are follow-up candidates
- **FileBrowserView also uses URLSession.shared**: Not in audit scope but noted for follow-up
- **StatusBadge only used by MCPServerListView**: Inline color indicators in other views use different patterns
- **No nonisolated markers exist yet**: Zero `nonisolated` keywords in entire ILSApp — all 5+ additions are net-new
- **MCPServerListView not MCPServersListView**: File is singular `MCPServerListView.swift`
- **Task ordering**: Core services (APIClient, SSEClient) first, then app entry (ILSAppApp), then ViewModels, then Views — dependency-aware
- **Build command**: `xcodebuild -project ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 16 Pro Max,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- **Simulator UDID**: 50523130-57AA-48B0-ABD0-4D59CE455F14 (iPhone 16 Pro Max, iOS 18.6)
- **didSet refactoring**: serverURL didSet → updateServerURL() method; also fixed lastSessionId didSet → updateLastSessionId(). SettingsView.swift had 2 callers that needed updating (saveServerSettings + testConnection). connectToServer() internally already used serverURL= which now calls updateServerURL(). No encoder/decoder properties in ILSAppApp.swift so nonisolated not applicable.
- **objectWillChange removal**: Was used after wasDisconnected recovery but @Published isConnected already triggers UI update. Removed safely.
- **Local property capture**: Added `let currentURL = self.serverURL` before async operations in Task closures to avoid repeated self access across await points
- **AppLogger interface**: `.info()`, `.warning()`, `.error()` with `category:` parameter. Categories: api, sse, app, chat, ui
- **ILSTheme fonts available**: `.titleFont`, `.headlineFont`, `.bodyFont`, `.captionFont`, `.codeFont`
- **Retry sleep already correct**: `performWithRetry` throw on `attempt == maxAttempts` exits before sleep — no fix needed for M-NET-2
- **Simulator must be booted**: xcodebuild destination requires booted simulator; use `xcrun simctl boot <UDID>` first, and use `platform=iOS Simulator,id=<UDID>` (without name) for reliable matching
- **Toast Task pattern**: Cancel previous toastTask, create new Task with Task.sleep(for:), guard !Task.isCancelled before mutation. Add .onDisappear { toastTask?.cancel() } for cleanup. 5 accessibility labels added to TunnelSettingsView (toggle, copy button, 3 text fields)

### Verification: 1.4 [VERIFY] Quality checkpoint: build succeeds after core service fixes
- Status: PASS
- Command: `xcodebuild -project ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after tasks 1.1-1.3 (APIClient, SSEClient, ILSAppApp fixes)
- Duration: ~60s (incremental build)

### Verification: 1.8 [VERIFY] Quality checkpoint: build succeeds after ViewModel fixes
- Status: PASS
- Command: `xcodebuild -project /Users/nick/Desktop/ils-ios/ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after tasks 1.5-1.7 (ChatViewModel Timer-to-Task, SystemMetricsViewModel dedicated URLSession, TunnelSettingsView DispatchQueue-to-Task)
- Duration: incremental build

## Learnings (Task 1.10)
- **SkillsViewModel didSet pattern**: gitHubSearchText didSet contained debounce logic. Extracted to `updateGitHubSearchText(_:)` + private `debouncedGitHubSearch()`. SkillsListView TextField uses binding + `.onChange(of:)` to call the update method. Only one caller (SkillsListView).

## Next

Task 1.13 [VERIFY] Quality checkpoint: build succeeds after all View/ViewModel fixes (1.9-1.12 all complete)
