---
spec: remaining-audit-fixes
basePath: specs/remaining-audit-fixes
phase: research
task: 0/0
updated: 2026-02-07T02:30:00Z
---

# Progress: remaining-audit-fixes

## Original Goal

Fix all remaining MEDIUM + LOW severity issues from the comprehensive 6-audit sweep (concurrency, memory, swiftui-architecture, swiftui-performance, networking, accessibility). CRITICAL and HIGH issues have already been fixed in commits bc1d2c6 and 233bf20.

## Completed Tasks

- [x] 1.1 Fix APIClient: scoped cache invalidation, skip final retry sleep, nonisolated coders
- [x] 1.2 Fix SSEClient: exponential backoff, nonisolated coders, print to AppLogger
- [x] 1.3 Fix ILSAppApp: weak capture, didSet to method, remove objectWillChange, nonisolated coders
- [x] 1.4 [VERIFY] Quality checkpoint: build succeeds after core service fixes
- [x] 1.5 Fix ChatViewModel: Timer to Task, cancellables cleanup, nonisolated decoder, print to AppLogger
- [x] 1.6 Fix SystemMetricsViewModel: dedicated URLSession, nonisolated decoder
- [x] 1.7 Fix TunnelSettingsView: DispatchQueue to Task, accessibility labels
- [x] 1.8 [VERIFY] Quality checkpoint: build succeeds after ViewModel fixes
- [x] 1.9 Fix SessionsListView: static formatters namespace, computed to method, font theme, color indicators
- [x] 1.10 Fix SkillsViewModel: didSet to method

- [x] 1.11 Fix ChatView: DispatchQueue to Task, computed to method
- [x] 1.12 Fix MetricsWebSocketClient: WebSocket fallback reset timer

- [x] 1.14 Fix remaining hardcoded fonts across 6 files
- [x] 1.15 Fix StatusBadge: augment color-only indicators with icon
- [x] 1.16 Fix remaining print() in CommandPaletteView
- [x] 2.1 Review and normalize AppLogger categories across all modified files
- [x] 2.2 Verify all Task cancellation paths are complete
- [x] 3.1 Build and install on simulator — validation only (no commit)

## Current Task

Awaiting next task

### Verification: 3.1 Build and install on simulator
- Status: PASS
- Build: BUILD SUCCEEDED (xcodebuild exit 0)
- Install: xcrun simctl install exit 0
- Launch: xcrun simctl launch exit 0 (PID 47513)
- Screenshot: Dashboard visible with 32 Sessions, 373 Projects, 1,481 Skills, 20 MCP Servers
- No visual regressions detected

## Learnings

- **Audit Scope**: 55 Swift files across 6 domains (concurrency, memory, architecture, performance, networking, accessibility)
- **Total Issues**: 43 (18 MEDIUM + 25 LOW) affecting 28 files
- **Effort**: 4-6 hours estimated
- **Pattern**: Most MEDIUM issues are defensive improvements, not critical bugs
- **SwiftUI Anti-pattern**: Published+didSet causes duplicate UI updates in AppState
- **Accessibility Gap**: 10 files use hardcoded font sizes bypassing theme system
- **Swift 6 Prep**: 4 concurrency issues preventative for strict mode
- **False Positives**: ~5 issues flagged but code already correct (SwiftUI defaults)
- **Research Method**: Grep pattern searches highly effective (8 patterns covered all domains)
- **Already Fixed**: QR code caching (bc1d2c6), search cache optimization (233bf20)
- **Requirements Phase**: 6 user stories map to 19 FRs, prioritized P1/P2/P3 by impact
- **Completeness Priority**: User interview confirmed fix ALL issues (no skips)
- **User Dual Focus**: Both developer experience (concurrency) and end-user (a11y) equally important
- **3-Phase Structure**: Phase 1 (MEDIUM P1), Phase 2 (LOW P2), Phase 3 (validation with evidence)
- **Success Gate**: Clean build + zero regressions + VoiceOver pass + Memory Instruments pass
- **Design Architecture**: In-place fixes with no restructuring — 21 issues across 18 files
- **File Grouping Strategy**: High-impact files (ILSAppApp, ChatViewModel, APIClient) get 3-4 fixes in single edit pass
- **Task-Based Timers**: Replace all Timer/DispatchQueue.asyncAfter with Task for Swift 6 alignment
- **URLSession Isolation**: Dedicated instances per ViewModel prevents @MainActor warnings
- **Cache Scoping**: Narrow invalidation to specific resources (not entire domains) improves hit rate
- **Exponential Backoff**: SSEClient needs true exponential (not linear) for reconnection
- **Formatter Pattern**: Move static formatters to namespace (SessionFormatters) not View properties
- **AppLogger Migration**: 30+ print() calls across 4 files need structured logging
- **Accessibility Compliance**: Status indicators need icon+text (not color-only) for WCAG 2.1
- **WebSocket Recovery**: 10min reset timer allows retry after transient failures
- **WS Reset Pattern**: Optional Date? + TimeInterval constant, check in connect() before fallback branch, set Date() when entering fallback
- **ChatView DispatchQueue**: Was in ChatInputView (same file), used for send button spring animation reset. Replaced with resetTask Task pattern. shouldShowTypingIndicator extracted from computed property to method.
- **SessionFormatters pattern**: Top-level enum with nonisolated(unsafe) static let for formatters. Circle status indicator replaced with HStack(Image+Text) using .caption2/.imageScale(.small) for icon + ILSTheme.captionFont for text. No hardcoded .font(.system(size:)) existed in this file — all already used ILSTheme fonts.

## Blockers

- None currently

## Learnings (Task Planning)

- **Actual font count lower**: Only 6 hardcoded `.font(.system(size:))` remain (not 10 as audited) — ios-app-polish2 already fixed most
- **DashboardViewModel no URLSession.shared**: Design listed M-CONC-1 for DashboardViewModel but code uses APIClient, not URLSession directly. Removed from tasks
- **didSet still present**: ILSAppApp.swift (lines 44, 61) and SkillsViewModel.swift (line 13) confirmed via grep
- **DispatchQueue.asyncAfter broader than scoped**: Found in 9 locations across 8 files, but audit only scoped 2 (TunnelSettingsView, ChatView). Others are follow-up candidates
- **FileBrowserView also uses URLSession.shared**: Not in audit scope but noted for follow-up
- **StatusBadge only used by MCPServerListView**: Inline color indicators in other views use different patterns
- **No nonisolated markers exist yet**: Zero `nonisolated` keywords in entire ILSApp — all 5+ additions are net-new
- **MCPServerListView not MCPServersListView**: File is singular `MCPServerListView.swift`
- **Task ordering**: Core services (APIClient, SSEClient) first, then app entry (ILSAppApp), then ViewModels, then Views — dependency-aware
- **Build command**: `xcodebuild -project ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 16 Pro Max,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- **Simulator UDID**: 50523130-57AA-48B0-ABD0-4D59CE455F14 (iPhone 16 Pro Max, iOS 18.6)
- **didSet refactoring**: serverURL didSet → updateServerURL() method; also fixed lastSessionId didSet → updateLastSessionId(). SettingsView.swift had 2 callers that needed updating (saveServerSettings + testConnection). connectToServer() internally already used serverURL= which now calls updateServerURL(). No encoder/decoder properties in ILSAppApp.swift so nonisolated not applicable.
- **objectWillChange removal**: Was used after wasDisconnected recovery but @Published isConnected already triggers UI update. Removed safely.
- **Local property capture**: Added `let currentURL = self.serverURL` before async operations in Task closures to avoid repeated self access across await points
- **AppLogger interface**: `.info()`, `.warning()`, `.error()` with `category:` parameter. Categories: api, sse, app, chat, ui
- **ILSTheme fonts available**: `.titleFont`, `.headlineFont`, `.bodyFont`, `.captionFont`, `.codeFont`
- **Retry sleep already correct**: `performWithRetry` throw on `attempt == maxAttempts` exits before sleep — no fix needed for M-NET-2
- **Simulator must be booted**: xcodebuild destination requires booted simulator; use `xcrun simctl boot <UDID>` first, and use `platform=iOS Simulator,id=<UDID>` (without name) for reliable matching
- **Toast Task pattern**: Cancel previous toastTask, create new Task with Task.sleep(for:), guard !Task.isCancelled before mutation. Add .onDisappear { toastTask?.cancel() } for cleanup. 5 accessibility labels added to TunnelSettingsView (toggle, copy button, 3 text fields)

### Verification: 1.4 [VERIFY] Quality checkpoint: build succeeds after core service fixes
- Status: PASS
- Command: `xcodebuild -project ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after tasks 1.1-1.3 (APIClient, SSEClient, ILSAppApp fixes)
- Duration: ~60s (incremental build)

### Verification: 1.8 [VERIFY] Quality checkpoint: build succeeds after ViewModel fixes
- Status: PASS
- Command: `xcodebuild -project <project-root>/ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after tasks 1.5-1.7 (ChatViewModel Timer-to-Task, SystemMetricsViewModel dedicated URLSession, TunnelSettingsView DispatchQueue-to-Task)
- Duration: incremental build

## Learnings (Task 1.10)
- **SkillsViewModel didSet pattern**: gitHubSearchText didSet contained debounce logic. Extracted to `updateGitHubSearchText(_:)` + private `debouncedGitHubSearch()`. SkillsListView TextField uses binding + `.onChange(of:)` to call the update method. Only one caller (SkillsListView).

## Learnings (Task 1.14)
- **Font replacement mapping**: size 44-48 → `.system(.largeTitle)` for decorative icons, size 36 → `.largeTitle`, size 20 → `.title3` for status icons, size 9 → `.caption2` for badge icons. All 6 occurrences across 4 files replaced with Dynamic Type compatible alternatives. Zero hardcoded `.font(.system(size:))` remain.

## Learnings (Task 1.15)
- **StatusBadge icon parameter**: Added `icon: String` with default `"circle.fill"` so existing callers without icon still compile. Replaced `Circle()` shape with `Image(systemName:)` + `.imageScale(.small)` for WCAG-compliant icon+text indicators. MCPServerDetailView also had inline Circle() status — replaced with StatusBadge for consistency. Only 2 callers in entire project (both MCPServerListView).

## Learnings (Task 2.2)
- **ChatView leaked Task**: `Task { @MainActor in` inside `.task {}` body created an unstructured task that escaped the `.task` modifier's cancellation scope. Fixed by replacing with `withTaskGroup` so error monitor and history loading both run as child tasks — automatically cancelled when view disappears.
- **Audit results**: ChatViewModel (batchTask, connectingTimer, cancellables) all properly cleaned up in deinit. TunnelSettingsView (toastTask) properly cancelled in onDisappear. ChatInputView (resetTask) properly cancelled in onDisappear. TypingIndicatorView animation loop uses `.task` modifier with `Task.isCancelled` guards — correct by default.
- **Pattern**: Unstructured `Task {}` inside `.task {}` modifier is a common SwiftUI anti-pattern — the inner task escapes structured concurrency. Use `withTaskGroup` or store + cancel manually.

- [x] 3.1 Build and install on simulator — app launches on UDID 50523130-57AA-48B0-ABD0-4D59CE455F14
- [x] 3.2 Capture evidence screenshots (6 key screens) — all captured and verified

## Learnings (Task 3.2)
- **idb companion must be explicitly started and connected**: `idb_companion --udid <UDID> &` then `idb connect localhost <port>`
- **Accessibility tree for coordinates**: `idb ui describe-all` returns JSON with exact frame coordinates — Remote Access row at cx=220, cy=445
- **Search bar intercepts taps**: SessionsListView search bar at top intercepts taps in that area; need to tap lower on session rows

## Next

Task 4.1: [VERIFY] Full local CI: clean build with strict warnings

### Verification: 3.3 [VERIFY] Functional spot-checks via automated verification
- Status: PASS
- Check 1: No print() calls (excluding AppLogger/comments) -- PASS (0 matches)
- Check 2: nonisolated markers (expect 5+) -- PASS (7 occurrences across 5 files: SSEClient x2, APIClient x2, SessionsListView x1, SystemMetricsViewModel x1, ChatViewModel x1)
- Check 3: SessionFormatters exists -- PASS (SessionsListView.swift lines 6, 348)
- Check 4: Exponential backoff (1 <<) -- PASS (SSEClient.swift line 166)
- Check 5: WebSocket reset (wsResetInterval) -- PASS (MetricsWebSocketClient.swift lines 33, 50)
- Check 6: StatusBadge has icon -- PASS (ILSTheme.swift line 318: Image(systemName: icon), line 308: let icon: String)
- Check 7: Zero Timer.scheduledTimer -- PASS (0 occurrences)
- Check 8: Zero URLSession.shared in ViewModels -- PASS (0 occurrences)
- All 8 automated spot-checks passed

### Verification: 1.13 [VERIFY] Quality checkpoint: build succeeds after all View/ViewModel fixes
- Status: PASS
- Command: `xcodebuild -project <project-root>/ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after tasks 1.9-1.12 (SessionsListView formatters, SkillsViewModel didSet, ChatView DispatchQueue-to-Task, MetricsWebSocketClient WS reset timer)
- Duration: incremental build

### Verification: 1.17 POC Checkpoint: full build + app launch verification
- Status: PASS
- Commands and results:
  1. Clean derived data: `rm -rf ~/Library/Developer/Xcode/DerivedData/ILSApp-*` -- PASS (exit 0)
  2. Clean build: `xcodebuild clean build` -- BUILD SUCCEEDED (exit 0, note: first attempt after clean failed due to parallel compilation race; second build succeeded)
  3. Zero `print()` across all Swift files: `grep -rn 'print(' --include='*.swift' | grep -v AppLogger | grep -v '//'` -- PASS (no matches)
  4. Zero `DispatchQueue.main.asyncAfter` in TunnelSettingsView.swift, ChatView.swift -- PASS (no matches, exit 1)
  5. Zero `Timer.scheduledTimer` calls -- PASS (no matches, exit 1)
  6. Zero `URLSession.shared` in ViewModels/ -- PASS (no matches, exit 1)
  7. Zero `objectWillChange.send()` -- PASS (no matches, exit 1)
  8. Zero `didSet` on @Published in ILSAppApp.swift, SkillsViewModel.swift (excluding comments) -- PASS (no matches)
- All 8 checks passed
- All 21 audit issues from Phase 1 confirmed resolved

### Verification: 2.3 [VERIFY] Quality checkpoint: clean build after refactoring
- Status: PASS
- Command: `xcodebuild -project <project-root>/ILSApp/ILSApp.xcodeproj -scheme ILSApp -configuration Debug -destination 'platform=iOS Simulator,id=50523130-57AA-48B0-ABD0-4D59CE455F14' build`
- Result: BUILD SUCCEEDED (exit 0)
- Zero compilation errors after Phase 2 refactoring tasks 2.1-2.2 (AppLogger category normalization, Task cancellation path verification)
- Duration: incremental build
